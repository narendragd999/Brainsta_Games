(function(){const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');const DPR=Math.min(window.devicePixelRatio||1,2);let W=1280,H=720;const ASSET='assets/';const bg=new Image();bg.src=ASSET+'background.png';const shipImg=new Image();shipImg.src=ASSET+'warship.png';const alienSmall=new Image();alienSmall.src=ASSET+'alien_small.png';const alienMed=new Image();alienMed.src=ASSET+'alien_medium.png';const alienBig=new Image();alienBig.src=ASSET+'alien_big.png';const soundPrimary=new Audio(ASSET+'shot_primary.wav');const soundSpread=new Audio(ASSET+'shot_spread.wav');const soundRadial=new Audio(ASSET+'shot_radial.wav');const soundExpl=new Audio(ASSET+'explosion.wav');let running=false,lastTime=0,score=0,hp=100;const scoreEl=document.getElementById('score-val'),hpEl=document.getElementById('hp-val'),weaponEl=document.getElementById('weapon-val');let weaponIndex=0;const weapons=['Primary','Spread','Radial','Omni'];weaponEl.textContent=weapons[weaponIndex];const player={x:400,y:360,r:36,ang:0,vx:0,vy:0,speed:360};const joystick=document.getElementById('left-joystick');const stick=joystick.querySelector('.stick');const fireBtn=document.getElementById('fire-btn');const switchBtn=document.getElementById('switch-btn');const startBtn=document.getElementById('start');const overlay=document.getElementById('overlay');let moveVec={x:0,y:0};let firing=false,fireCooldown=0;let bullets=[],enemies=[],particles=[],stars=[];let spawnTimer=0,wave=1;function resize(){const w=Math.max(window.innerWidth,360),h=Math.max(window.innerHeight,360);canvas.style.width=w+'px';canvas.style.height=h+'px';canvas.width=Math.round(w*DPR);canvas.height=Math.round(h*DPR);W=canvas.width;H=canvas.height;ctx.setTransform(DPR,0,0,DPR,0,0);}function initStars(){stars=[];for(let i=0;i<160;i++)stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.6+0.4,speed:0.3+Math.random()*1.1});}let pointerId=null;joystick.addEventListener('pointerdown',ev=>{ev.preventDefault();joystick.setPointerCapture(ev.pointerId);pointerId=ev.pointerId;updateStick(ev.clientX,ev.clientY);});window.addEventListener('pointermove',ev=>{if(pointerId===ev.pointerId)updateStick(ev.clientX,ev.clientY);});window.addEventListener('pointerup',ev=>{if(pointerId===ev.pointerId){resetStick();try{joystick.releasePointerCapture(ev.pointerId);}catch(e){}pointerId=null;}});function updateStick(clientX,clientY){const rect=joystick.getBoundingClientRect();const cx=rect.left+rect.width/2,cy=rect.top+rect.height/2;const dx=clientX-cx,dy=clientY-cy;const dist=Math.hypot(dx,dy)||1;const max=rect.width*0.36;const nx=dx/dist,ny=dy/dist;const clamped=Math.min(dist,max);stick.style.transform=`translate(${nx*clamped*0.5}px, ${ny*clamped*0.5}px)`;moveVec.x=(clamped/max)*nx;moveVec.y=(clamped/max)*ny;}function resetStick(){stick.style.transform='translate(0px, 0px)';moveVec.x=0;moveVec.y=0;}fireBtn.addEventListener('pointerdown',e=>{e.preventDefault();firing=true});fireBtn.addEventListener('pointerup',e=>{e.preventDefault();firing=false});switchBtn.addEventListener('click',()=>{weaponIndex=(weaponIndex+1)%weapons.length;weaponEl.textContent=weapons[weaponIndex];});function playSound(s){try{s.currentTime=0;s.play();}catch(e){}}function shootPrimary(x,y,ang){const nx=Math.cos(ang),ny=Math.sin(ang);bullets.push({x:x+nx*44,y:y+ny*44,vx:nx*940,vy:ny*940,ttl:1.6,dmg:10});playSound(soundPrimary);}function shootSpread(x,y,ang){const angles=[ang-0.22,ang,ang+0.22];for(const a of angles){const nx=Math.cos(a),ny=Math.sin(a);bullets.push({x:x+nx*40,y:y+ny*40,vx:nx*840,vy:ny*840,ttl:1.6,dmg:8});}playSound(soundSpread);}function shootRadial(x,y){for(let i=0;i<4;i++){const a=i*(Math.PI/2);const nx=Math.cos(a),ny=Math.sin(a);bullets.push({x:x+nx*20,y:y+ny*20,vx:nx*560,vy:ny*560,ttl:1.6,dmg:6});}playSound(soundRadial);}function shootOmni(x,y){for(let i=0;i<8;i++){const a=i*(Math.PI*2/8);const nx=Math.cos(a),ny=Math.sin(a);bullets.push({x:x+nx*20,y:y+ny*20,vx:nx*520,vy:ny*520,ttl:1.6,dmg:5});}playSound(soundRadial);}function fireWeapon(){const ang=0;if(weaponIndex===0)shootPrimary(player.x,player.y,ang);else if(weaponIndex===1)shootSpread(player.x,player.y,ang);else if(weaponIndex===2)shootRadial(player.x,player.y);else if(weaponIndex===3)shootOmni(player.x,player.y);}function spawnEnemy(type){const edge=Math.floor(Math.random()*4);let x,y;if(edge===0){x=-140;y=Math.random()*H;}else if(edge===1){x=W+140;y=Math.random()*H;}else if(edge===2){x=Math.random()*W;y=-140;}else{x=Math.random()*W;y=H+140;}if(type===1)enemies.push({x,y,vx:0,vy:0,speed:80,r:28,type:1,hp:18,img:alienSmall,score:12});else if(type===2)enemies.push({x,y,vx:0,vy:0,speed:60,r:36,type:2,hp:34,img:alienMed,score:28});else enemies.push({x,y,vx:0,vy:0,speed:40,r:60,type:3,hp:86,img:alienBig,score:100});}function createParticles(x,y,count,spread){for(let i=0;i<count;i++){const a=Math.random()*Math.PI*2;const s=Math.random()*spread;const spd=40+Math.random()*260;particles.push({x:x+Math.cos(a)*s*0.2,y:y+Math.sin(a)*s*0.2,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:0.4+Math.random()*0.9,r:2+Math.random()*3});}}function update(dt){const tx=moveVec.x,ty=moveVec.y;const tvx=tx*player.speed,tvy=ty*player.speed;player.vx+=(tvx-player.vx)*Math.min(dt*12,1);player.vy+=(tvy-player.vy)*Math.min(dt*12,1);player.x+=player.vx*dt;player.y+=player.vy*dt;player.x=Math.max(60,Math.min(W-60,player.x));player.y=Math.max(60,Math.min(H-60,player.y));fireCooldown-=dt;if(firing&&fireCooldown<=0){fireWeapon();fireCooldown=0.14;}for(let i=bullets.length-1;i>=0;i--){const b=bullets[i];b.ttl-=dt;b.x+=b.vx*dt;b.y+=b.vy*dt;if(b.ttl<=0||b.x<-80||b.x>W+80||b.y<-80||b.y>H+80)bullets.splice(i,1);}spawnTimer+=dt;const interval=Math.max(0.5,1.6-Math.min(1.4,wave*0.04));if(spawnTimer>interval){spawnTimer=0;const r=Math.random();if(r<0.55)spawnEnemy(1);else if(r<0.88)spawnEnemy(2);else spawnEnemy(3);}for(let i=enemies.length-1;i>=0;i--){const e=enemies[i];const dx=player.x-e.x,dy=player.y-e.y;const d=Math.hypot(dx,dy)||1;e.vx+=((dx/d)*e.speed-e.vx)*Math.min(dt*2.6,1);e.vy+=((dy/d)*e.speed-e.vy)*Math.min(dt*2.6,1);e.x+=e.vx*dt;e.y+=e.vy*dt;if(Math.hypot(e.x-player.x,e.y-player.y)<e.r+player.r-10){createParticles(player.x,player.y,16,12);playSound(soundExpl);enemies.splice(i,1);hp-=18;if(hp<=0)gameOver();continue;}for(let j=bullets.length-1;j>=0;j--){const b=bullets[j];if(Math.hypot(b.x-e.x,b.y-e.y)<e.r+8){bullets.splice(j,1);e.hp-=b.dmg||10;createParticles(b.x,b.y,6,6);if(e.hp<=0){score+=e.score||10;playSound(soundExpl);createParticles(e.x,e.y,28,14);enemies.splice(i,1);}else{playSound(soundSpread);}break;}}}for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.life-=dt;if(p.life<=0)particles.splice(i,1);p.x+=p.vx*dt;p.y+=p.vy*dt;p.vx*=0.992;p.vy*=0.992;}scoreEl.textContent=Math.floor(score);hpEl.textContent=Math.max(0,Math.floor(hp));if(score>wave*200)wave++;}function draw(){if(bg.complete){const img=bg;const ratio=Math.max(W/img.width,H/img.height);const iw=img.width*ratio,ih=img.height*ratio;ctx.drawImage(img,(W-iw)/2,(H-ih)/2,iw,ih);}else{ctx.fillStyle='#071427';ctx.fillRect(0,0,W,H);}for(const s of stars){ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,0.9)';ctx.fill();}ctx.save();ctx.globalCompositeOperation='lighter';for(const b of bullets){ctx.beginPath();ctx.arc(b.x,b.y,6,0,Math.PI*2);ctx.fillStyle='rgba(180,255,255,0.95)';ctx.fill();ctx.beginPath();ctx.arc(b.x,b.y,2.5,0,Math.PI*2);ctx.fillStyle='white';ctx.fill();}ctx.restore();for(const e of enemies){ctx.save();ctx.translate(e.x,e.y);const s=1-Math.max(0, e.spawn||0);ctx.drawImage(e.img,-48*s,-48*s,96*s,96*s);ctx.restore();}ctx.save();ctx.globalCompositeOperation='lighter';for(const p of particles){ctx.beginPath();ctx.arc(p.x,p.y,p.r*1.6,0,Math.PI*2);ctx.fillStyle='rgba(255,200,140,0.9)';ctx.fill();}ctx.restore();ctx.save();ctx.translate(player.x,player.y);ctx.rotate(player.ang);ctx.drawImage(shipImg,-72,-54,144,108);ctx.restore();}function loop(ts){if(!lastTime)lastTime=ts;const dt=Math.min(0.033,(ts-lastTime)/1000);lastTime=ts;if(running)update(dt);draw();requestAnimationFrame(loop);}function startGame(){overlay.classList.remove('overlay-visible');overlay.classList.add('overlay-hidden');overlay.style.display='none';bullets=[];enemies=[];particles=[];stars=[];spawnTimer=0;wave=1;score=0;hp=100;player.x=W/2;player.y=H/2;running=true;try{soundPrimary.play().then(()=>{soundPrimary.pause();soundPrimary.currentTime=0}).catch(()=>{});}catch(e){} }function gameOver(){running=false;overlay.style.display='flex';overlay.classList.add('overlay-visible');overlay.classList.remove('overlay-hidden');}startBtn.addEventListener('click',startGame);document.getElementById('start2').addEventListener('click',startGame);window.addEventListener('resize',resize);resize();initStars();requestAnimationFrame(loop);})();